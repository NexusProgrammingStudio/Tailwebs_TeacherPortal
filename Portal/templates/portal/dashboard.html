<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap 5 JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <style>
      .form-error,
      .form-error-inline {
        font-size: 0.85rem;
        margin-top: 0.25rem;
        color: #dc2626; /* Tailwind red-600 */
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-red-600">tailwebs.</h1>
      <div class="space-x-4">
        <a href="{% url 'dashboard' %}" class="text-sm font-medium">Home</a>
        <a href="{% url 'logout' %}" class="text-sm font-medium">Logout</a>
      </div>
    </nav>

    <!-- Content -->
    <div class="p-6">
      <!-- Add Button -->
      <div class="flex justify-end mb-4">
        <button
          onclick="document.getElementById('addModal').classList.remove('hidden')"
          class="bg-black text-white px-5 py-2 rounded"
        >
          Add
        </button>
      </div>

      <!-- Student Table -->
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full text-sm table table-bordered">
          <thead class="bg-gray-200 text-left">
            <tr class="text-gray-600">
              <th class="p-3">Name</th>
              <th class="p-3">Subject</th>
              <th class="p-3">Mark</th>
              <th class="p-3">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr
              class="border-t hover:bg-gray-50 align-middle"
              data-id="{{ student.id }}"
            >
              <td class="p-3">
                <div class="d-flex align-items-center gap-2">
                  <div
                    class="bg-blue-600 text-white rounded-circle d-flex justify-content-center align-items-center"
                    style="width: 32px; height: 32px"
                  >
                    {{ student.name|slice:":1"|upper }}
                  </div>
                  <span class="student-name">{{ student.name }}</span>
                  <input
                    type="text"
                    class="form-control form-control-sm edit-name d-none"
                    value="{{ student.name }}"
                  />
                </div>
              </td>
              <td class="p-3">
                <span class="student-subject">{{ student.subject }}</span>
                <input
                  type="text"
                  class="form-control form-control-sm edit-subject d-none"
                  value="{{ student.subject }}"
                />
              </td>
              <td class="p-3">
                <span class="student-marks">{{ student.marks }}</span>
                <input
                  type="number"
                  class="form-control form-control-sm edit-marks d-none"
                  value="{{ student.marks }}"
                />
              </td>
              <td class="p-3">
                <!-- Default dropdown shown only when not editing -->
                <div class="dropdown action-dropdown">
                  <button
                    class="btn btn-outline-secondary btn-sm dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                  >
                    Options
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="startInlineEdit(this)"
                        >Edit</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item text-danger"
                        href="#"
                        onclick="deleteStudent({{ student.id }})"
                        >Delete</a
                      >
                    </li>
                  </ul>
                </div>

                <!-- Save/Cancel shown only during editing -->
                <div class="edit-actions d-none d-flex gap-2">
                  <button
                    class="btn btn-sm btn-success"
                    onclick="saveInlineEdit(this, {{student.id}})"
                  >
                    Save
                  </button>
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="cancelInlineEdit(this)"
                  >
                    Cancel
                  </button>
                </div>
              </td>
            </tr>

            {% empty %}
            <tr>
              <td colspan="4" class="p-4 text-center text-gray-500">
                No students found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Student Modal -->
    <div
      id="addModal"
      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
        <h2 class="text-lg font-semibold mb-4">Add Student</h2>
        <form id="addStudentForm">
          {% csrf_token %}
          <div id="formError" class="text-red-600 text-sm mb-2 hidden"></div>
          <div class="mb-4">
            <label class="block text-sm mb-1">Name</label>
            <input
              type="text"
              name="name"
              class="w-full border px-3 py-2 rounded"
              required
              minlength="2"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm mb-1">Subject</label>
            <input
              type="text"
              name="subject"
              class="w-full border px-3 py-2 rounded"
              required
              minlength="2"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm mb-1">Mark</label>
            <input
              type="number"
              name="marks"
              class="w-full border px-3 py-2 rounded"
              required
              min="0"
              max="100"
            />
          </div>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              onclick="document.getElementById('addModal').classList.add('hidden')"
              class="px-4 py-2 bg-gray-300 rounded"
            >
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-black text-white rounded">
              Add
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // Delete student with CSRF
      function deleteStudent(id) {
        if (confirm("Are you sure you want to delete this student?")) {
          fetch(`/delete-student/${id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
          }).then(() => window.location.reload());
        }
      }

      // Validate form (used by Add & Edit)
      function validateStudentForm(form) {
        const name = form.querySelector('[name="name"]').value.trim();
        const subject = form.querySelector('[name="subject"]').value.trim();
        const marks = form.querySelector('[name="marks"]').value.trim();

        const nameRegex = /^[A-Za-z ]{2,}$/;
        const subjectRegex = /^[A-Za-z ]{2,}$/;

        // Clear existing errors
        form.querySelectorAll(".form-error")?.forEach((el) => el.remove());

        let valid = true;

        function showError(input, message) {
          const error = document.createElement("div");
          error.classList.add("form-error");
          error.innerText = message;
          input.after(error);
          valid = false;
        }

        const nameInput = form.querySelector('[name="name"]');
        const subjectInput = form.querySelector('[name="subject"]');
        const marksInput = form.querySelector('[name="marks"]');

        if (!nameRegex.test(name)) {
          showError(nameInput, "Name must be at least 2 letters.");
        }

        if (!subjectRegex.test(subject)) {
          showError(subjectInput, "Subject must be at least 2 letters.");
        }

        const marksValue = Number(marks);
        if (isNaN(marksValue) || marksValue < 0 || marksValue > 100) {
          showError(marksInput, "Marks must be a number between 0 and 100.");
        }

        return valid;
      }

      // Add Student
      document
        .getElementById("addStudentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          // Clear old error
          const errorDiv = document.getElementById("formError");
          errorDiv.classList.add("hidden");
          errorDiv.textContent = "";
          if (!validateStudentForm(this)) return;

          const formData = new FormData(this);
          fetch("{% url 'add_student' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: formData,
          })
            .then((response) =>
              response
                .json()
                .then((data) => ({ status: response.status, body: data }))
            )
            .then(({ status, body }) => {
              if (status === 200 && body.status === "success") {
                form.reset();
                document.getElementById("addModal").classList.add("hidden");
                window.location.reload();
              } else {
                const errorMessage =
                  typeof body.error === "string"
                    ? body.error
                    : "An error occurred. Please check your inputs.";
                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove("hidden");
              }
            })
            .catch((error) => {
              errorDiv.textContent = "Something went wrong. Try again later.";
              errorDiv.classList.remove("hidden");
            });
        });

      // Edit Student
      document
        .getElementById("editStudentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (!validateStudentForm(this)) return;

          const id = document.getElementById("edit-id").value;
          const formData = new FormData(this);

          fetch(`/update-student/${id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            body: formData,
          }).then(() => {
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editModal")
            );
            modal.hide();
            window.location.reload();
          });
        });

      // Inline Editing Start
      function startInlineEdit(link) {
        const row = link.closest("tr");
        row
          .querySelectorAll(".student-name, .student-subject, .student-marks")
          .forEach((el) => el.classList.add("d-none"));
        row
          .querySelectorAll(".edit-name, .edit-subject, .edit-marks")
          .forEach((el) => el.classList.remove("d-none"));

        row.querySelector(".action-dropdown").classList.add("d-none");
        row.querySelector(".edit-actions").classList.remove("d-none");
      }

      // Inline Cancel
      function cancelInlineEdit(btn) {
        const row = btn.closest("tr");

        // Show static text, hide inputs
        row
          .querySelectorAll(".student-name, .student-subject, .student-marks")
          .forEach((el) => el.classList.remove("d-none"));
        row
          .querySelectorAll(".edit-name, .edit-subject, .edit-marks")
          .forEach((el) => el.classList.add("d-none"));

        // Toggle buttons
        row.querySelector(".action-dropdown").classList.remove("d-none");
        row.querySelector(".edit-actions").classList.add("d-none");

        // Remove all error messages (frontend + backend errors)
        row
          .querySelectorAll(".form-error-inline, .inline-edit-error")
          .forEach((el) => el.remove());
      }

      // Inline Validation Function
      function validateInlineInputs(row) {
        const nameInput = row.querySelector(".edit-name");
        const subjectInput = row.querySelector(".edit-subject");
        const marksInput = row.querySelector(".edit-marks");

        const name = nameInput.value.trim();
        const subject = subjectInput.value.trim();
        const marks = marksInput.value.trim();

        const nameRegex = /^[A-Za-z ]{2,}$/;
        const subjectRegex = /^[A-Za-z ]{2,}$/;

        // Remove previous inline errors
        row
          .querySelectorAll(".form-error-inline")
          ?.forEach((el) => el.remove());

        let valid = true;

        function showError(input, message) {
          const error = document.createElement("div");
          error.classList.add("form-error-inline");
          error.innerText = message;
          input.after(error);
          valid = false;
        }

        if (!nameRegex.test(name)) {
          showError(nameInput, "Name must be at least 2 letters.");
        }

        if (!subjectRegex.test(subject)) {
          showError(subjectInput, "Subject must be at least 2 letters.");
        }

        const marksValue = Number(marks);
        if (isNaN(marksValue) || marksValue < 0 || marksValue > 100) {
          showError(marksInput, "Marks must be between 0 and 100.");
        }

        return valid;
      }

      // Inline Save
      function saveInlineEdit(btn, id) {
        const row = btn.closest("tr");
        const nameInput = row.querySelector(".edit-name");
        const subjectInput = row.querySelector(".edit-subject");
        const marksInput = row.querySelector(".edit-marks");

        const name = nameInput.value.trim();
        const subject = subjectInput.value.trim();
        const marks = marksInput.value.trim();

        // Remove previous error
        let errorEl = row.querySelector(".inline-edit-error");
        if (!errorEl) {
          errorEl = document.createElement("div");
          errorEl.classList.add(
            "inline-edit-error",
            "text-danger",
            "text-sm",
            "mt-2"
          );
          row.lastElementChild.appendChild(errorEl); // append in last <td>
        }
        errorEl.classList.add("d-none");
        errorEl.textContent = "";

        // Client-side validation
        const nameRegex = /^[A-Za-z ]{2,}$/;
        const subjectRegex = /^[A-Za-z ]{2,}$/;
        const marksValue = Number(marks);

        if (!nameRegex.test(name)) {
          errorEl.textContent =
            "Name must be at least 2 characters (letters and spaces only)";
          errorEl.classList.remove("d-none");
          return;
        }
        if (!subjectRegex.test(subject)) {
          errorEl.textContent =
            "Subject must be at least 2 characters (letters and spaces only)";
          errorEl.classList.remove("d-none");
          return;
        }
        if (isNaN(marksValue) || marksValue < 0 || marksValue > 100) {
          errorEl.textContent = "Marks must be between 0 and 100.";
          errorEl.classList.remove("d-none");
          return;
        }

        // Prepare data
        const formData = new FormData();
        formData.append("name", name);
        formData.append("subject", subject);
        formData.append("marks", marks);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        // Send update request
        fetch(`/update-student/${id}/`, {
          method: "POST",
          body: formData,
        })
          .then((response) =>
            response
              .json()
              .then((data) => ({ status: response.status, body: data }))
          )
          .then(({ status, body }) => {
            if (status === 200 && body.status === "updated") {
              window.location.reload();
            } else {
              const errorMsg =
                typeof body.error === "string"
                  ? body.error
                  : "Update failed. Please check your inputs.";
              errorEl.textContent = errorMsg;
              errorEl.classList.remove("d-none");
            }
          })
          .catch((err) => {
            errorEl.textContent = "Something went wrong. Try again later.";
            errorEl.classList.remove("d-none");
          });
      }
    </script>
  </body>
</html>
